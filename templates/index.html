{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<h2>Initiatives</h2>

{% if 'user_id' not in session %}
    <p style="color: red;">Чтобы голосовать, необходимо авторизоваться!</p>
{% endif %}

{% for initiative in initiatives %}
    <div class="initiative" id="initiative-{{ initiative[0] }}">
        <h3>{{ initiative[1] }}</h3> <!-- Title -->
        <p>{{ initiative[2] }}</p> <!-- Content -->
        <small>Created on {{ initiative[3] }}</small>

        <!-- Voting buttons -->
        {% if 'user_id' in session %}
        <div>
            <button class="vote-btn" data-initiative-id="{{ initiative[0] }}" data-vote-value="1">Like</button>
            <button class="vote-btn" data-initiative-id="{{ initiative[0] }}" data-vote-value="-1">Dislike</button>
        </div>
        {% endif %}

        <!-- Like and Dislike counters -->
        <p>Likes: <span id="likes-{{ initiative[0] }}">{{ initiative_likes[initiative[0]] }}</span></p>
        <p>Dislikes: <span id="dislikes-{{ initiative[0] }}">{{ initiative_dislikes[initiative[0]] }}</span></p>
    </div>
{% endfor %}

{% if initiatives|length < total_initiatives %}
    <button id="load-more-btn" data-page="2">Load more</button>
{% endif %}

<script>
    document.getElementById('load-more-btn')?.addEventListener('click', function() {
        const page = this.getAttribute('data-page');
        
        fetch(`/load_more_initiatives?page=${page}`)
        .then(response => response.json())
        .then(data => {
            const initiativesContainer = document.querySelector('main');
            data.initiatives.forEach((initiative) => {
                const initiativeElement = document.createElement('div');
                initiativeElement.classList.add('initiative');
                initiativeElement.id = `initiative-${initiative.id}`;
                initiativeElement.innerHTML = `
                    <h3>${initiative.title}</h3>
                    <p>${initiative.content}</p>
                    <small>Created on ${initiative.date_created}</small>
                    <div>
                        <button class="vote-btn" data-initiative-id="${initiative.id}" data-vote-value="1">Like</button>
                        <button class="vote-btn" data-initiative-id="${initiative.id}" data-vote-value="-1">Dislike</button>
                    </div>
                    <p>Likes: <span id="likes-${initiative.id}">${initiative.likes}</span></p>
                    <p>Dislikes: <span id="dislikes-${initiative.id}">${initiative.dislikes}</span></p>
                `;
                initiativesContainer.appendChild(initiativeElement);
            });

            // Update the page number for next request
            this.setAttribute('data-page', parseInt(page) + 1);

            // If no more initiatives, remove the "Load more" button
            if (data.initiatives.length + (page - 1) * 20 >= data.total_initiatives) {
                this.style.display = 'none';
            }
        })
        .catch((error) => {
            console.error('Error loading more initiatives:', error);
        });
    });

    // Обработчик голосования
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('vote-btn')) {
            const initiativeId = event.target.getAttribute('data-initiative-id');
            const voteValue = event.target.getAttribute('data-vote-value');

            fetch('/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initiative_id: initiativeId, vote_value: parseInt(voteValue) })
            })
            .then(response => response.json())
            .then(data => {
                // Обновляем счётчики лайков и дизлайков
                document.getElementById(`likes-${initiativeId}`).textContent = data.likes;
                document.getElementById(`dislikes-${initiativeId}`).textContent = data.dislikes;
            })
            .catch(error => {
                console.error('Error while voting:', error);
            });
        }
    });
</script>
{% endblock %}




